<% layout('layouts/boilerplate') -%>

<body>
  <script>
    const mapToken = "<%= process.env.MAP_TOKEN %>";
    const listing = <%- JSON.stringify(listing) %>;
  </script>
  <div class="row">
    <div class="col-12 col-md-8 offset-md-2" style="padding: 10px">
      <h3 class="mt-3">listing details</h3>

      <div class="card">
        <img
          src="<%= listing.image.url %>"
          class="card-img-top show-image"
          alt="listing-img"
        />
        <div class="card-body">
          <h5 class="card-title"><%= listing.title %></h5>

          <p class="card-text">Owned By:- <%= listing.owner.username%></p>

          <p class="card-text"><%= listing.description %></p>
          <p class="card-text">
            &#8377;<%= listing.price.toLocaleString("en-IN") %>
          </p>
          <p class="card-text">
            <%= listing.location %>, <%= listing.country %>
          </p>

          <% if(currentUser && currentUser._id.equals(listing.owner._id)) { %>
          <div class="row">
            <div class="col-12 col-md-6 mb-2">
              <a
                href="/listing/<%=listing._id%>/edit"
                class="btn btn-dark w-100"
                >EDIT</a
              >
            </div>
            <div class="col-12 col-md-6 mb-2">
              <form
                method="POST"
                action="/listing/<%=listing._id%>?_method=DELETE"
              >
                <button class="btn btn-danger w-100">DELETE</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <% } %>
      <hr />

      <div class="review-section mb-3">
        <% if(currentUser) { %>
        <h4>Leave a Review</h4>
        <form
          action="/listing/<%= listing._id %>/review"
          method="post"
          novalidate
          class="needs-validation"
        >
          <div class="invalid-feedback">Please add comment.</div>
          <div class="mb-2">
            <label for="rating" class="form-label">Rating</label>
            <fieldset class="starability-slot">
              <input
                type="radio"
                id="no-rate"
                class="input-no-rate"
                name="review[rating]"
                value="1"
                checked
                aria-label="No rating."
              />
              <input
                type="radio"
                id="first-rate1"
                name="review[rating]"
                value="1"
              />
              <label for="first-rate1" title="Terrible">1 star</label>
              <input
                type="radio"
                id="first-rate2"
                name="review[rating]"
                value="2"
              />
              <label for="first-rate2" title="Not good">2 stars</label>
              <input
                type="radio"
                id="first-rate3"
                name="review[rating]"
                value="3"
              />
              <label for="first-rate3" title="Average">3 stars</label>
              <input
                type="radio"
                id="first-rate4"
                name="review[rating]"
                value="4"
              />
              <label for="first-rate4" title="Very good">4 stars</label>
              <input
                type="radio"
                id="first-rate5"
                name="review[rating]"
                value="5"
              />
              <label for="first-rate5" title="Amazing">5 stars</label>
            </fieldset>
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">Comment</label>
            <textarea
              name="review[comment]"
              id="comment"
              class="form-control"
              cols="30"
              rows="5"
              required
            ></textarea>
            <div class="invalid-feedback">please add the comment</div>
          </div>
          <button class="btn btn-outline-dark mt-2">Submit</button>
        </form>
        <hr />
        <% } %>
        <br />
        
        <!-- Reviews Section -->
        <div class="reviews-container">
          <% if(listing.reviews.length > 0) { %>
          <h4>All Reviews</h4>
          <% for(let i = 0; i < listing.reviews.length; i++) { %> 
          <% let review = listing.reviews[i]; %>
          <div class="review-card mb-3">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">@<%= review.author.username%></h6>
                <p
                  class="starability-result card-text"
                  data-rating="<%= review.rating %>"
                ></p>
                <p class="card-text"><%= review.comment %></p>
                <small class="text-muted"
                  ><%= review.createdAt.toDateString() %></small
                >
                <form
                  action="/listing/<%=listing._id%>/review/<%=review._id%>?_method=DELETE"
                  method="POST"
                  class="mt-2"
                >
                  <button class="btn btn-outline-danger btn-sm">Delete</button>
                </form>
              </div>
            </div>
          </div>
          <% } %> 
          <% } %>
        </div>
        
        <!-- Map Section -->
        </div>
      </div>
      
      <!-- Map Section - Outside the main container -->
      <div class="col-12 col-md-8 offset-md-2" style="padding: 10px">
        <div class="map-section mb-3">
          <h5>Where you'll be:</h5>
          <div id="map"></div>
        </div>
      </div>
    </div>

  <script src="/js/map.js"></script>

  <style>
    /* Animations and smooth transitions */
    * {
      box-sizing: border-box;
    }

    /* Smooth page entrance */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .row {
      margin: 0;
      padding: 0 15px;
    }

    .col-12.col-md-8.offset-md-2 {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease-out;
    }

    /* Card styles */
    .card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      animation: scaleIn 0.6s ease-out;
    }

    .card-img-top {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }

    .card-body {
      padding: 20px;
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }

    .card-text {
      color: #666;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    /* Typography */
    h3 {
      color: #333;
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
      text-transform: capitalize;
      animation: slideInLeft 0.7s ease-out;
    }

    h4 {
      color: #333;
      margin-bottom: 25px;
      font-weight: 500;
      animation: slideInLeft 0.8s ease-out;
    }

    h5 {
      color: #333;
      margin-bottom: 15px;
      font-weight: 500;
      animation: slideInLeft 0.9s ease-out;
    }

    /* Form styles */
    .form-label {
      color: #555;
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 16px; /* Prevents zoom on iOS */
      resize: vertical;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #007bff;
    }

    /* Button styles */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: 1px solid #333;
      border-radius: 6px;
      background: transparent;
      color: #333;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      min-height: 48px; /* Better touch target */
    }

    .btn:hover {
      background: #333;
      color: white;
    }

    .btn:active {
      background: #555;
    }

    .btn-dark {
      background: #333;
      color: white;
      border-color: #333;
    }

    .btn-dark:hover {
      background: #555;
      border-color: #555;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
      border-color: #bd2130;
    }

    .btn-outline-danger {
      color: #dc3545;
      border-color: #dc3545;
      background: transparent;
    }

    .btn-outline-danger:hover {
      background: #dc3545;
      color: white;
    }

    .btn-outline-dark {
      color: #333;
      border-color: #333;
      background: transparent;
    }

    .btn-outline-dark:hover {
      background: #333;
      color: white;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
      min-height: auto;
    }

    .w-100 {
      width: 100%;
    }

    /* Spacing utilities */
    .mb-2 {
      margin-bottom: 15px;
    }

    .mb-3 {
      margin-bottom: 20px;
    }

    .mt-2 {
      margin-top: 15px;
    }

    .mt-3 {
      margin-top: 20px;
    }

    /* Map styles */
    #map {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      border: 1px solid #ddd;
      animation: scaleIn 1.1s ease-out;
    }

    .map-section {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      animation: fadeInUp 0.9s ease-out;
    }

    /* Review section */
    .review-section {
      width: 100%;
      animation: fadeInUp 1s ease-out;
    }

    .reviews-container {
      width: 100%;
    }

    .review-card {
      width: 100%;
      animation: slideInLeft 0.6s ease-out;
      animation-fill-mode: both;
    }

    /* Stagger animation for multiple reviews */
    .review-card:nth-child(1) { animation-delay: 0.1s; }
    .review-card:nth-child(2) { animation-delay: 0.2s; }
    .review-card:nth-child(3) { animation-delay: 0.3s; }
    .review-card:nth-child(4) { animation-delay: 0.4s; }
    .review-card:nth-child(5) { animation-delay: 0.5s; }

    /* Keep original star rating styles - don't modify */

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .col-12.col-md-8.offset-md-2 {
        padding: 15px;
        margin: 10px;
        border-radius: 8px;
      }

      .card-body {
        padding: 15px;
      }

      .card-title {
        font-size: 1.3rem;
      }

      h3 {
        font-size: 1.4rem;
        margin-bottom: 20px;
      }

      h4 {
        font-size: 1.2rem;
        margin-bottom: 20px;
      }

      .form-control {
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on mobile */
      }

      .btn {
        padding: 14px 20px;
        font-size: 16px;
        min-height: 50px; /* Better touch targets */
      }

      .btn-sm {
        padding: 10px 16px;
        font-size: 14px;
        min-height: auto;
      }

      /* Stack edit/delete buttons on mobile */
      .row .col-12.col-md-6 {
        margin-bottom: 10px;
      }

      /* Map responsive */
      #map {
        height: 350px;
      }

      .card-img-top {
        height: 200px;
      }

      /* Review cards stack properly */
      .review-card {
        margin-bottom: 15px;
      }

      /* Ensure proper spacing on mobile */
      .mb-2 {
        margin-bottom: 12px;
      }

      .mb-3 {
        margin-bottom: 18px;
      }

      /* Better form spacing on mobile */
      .form-label {
        font-size: 16px;
      }

      textarea.form-control {
        min-height: 120px;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      .row {
        padding: 0 10px;
      }

      .col-12.col-md-8.offset-md-2 {
        padding: 12px;
        margin: 5px;
      }

      .card-body {
        padding: 12px;
      }

      h3 {
        font-size: 1.2rem;
      }

      .card-title {
        font-size: 1.1rem;
      }

      .btn {
        padding: 12px 16px;
        min-height: 48px;
      }

      #map {
        height: 300px;
      }

      .card-img-top {
        height: 180px;
      }
    }

    /* Ensure touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        /* Disable hover effects on touch devices */
      }
      
      .btn:active {
        transform: scale(0.98);
      }
    }

    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .card-img-top {
        image-rendering: -webkit-optimize-contrast;
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* Dark mode support - removed */
  </style>
</body>
